{% extends "base.tpl.html" %}

{% block raiz %}
    <a class="navbar-brand link" href="/">REI-NET</a>
{% endblock %}

{% block barraderecha %}
    <li id="usuario" class="show">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">{{ usuario.username }}<b class="caret"></b>
        </a>
        <ul class="dropdown-menu">
            <li><a href="/perfilUsuario/">Mi Perfil</a></li>
            {% if not es_admin %}
            <li><a href="/registro_institucion">Registrar Institucion</a></li>
            {% endif %}
            <li><a href="/cerrarSesion/">Cerrar Sesi&oacute;n</a></li>
        </ul>
    </li>
    <li id="mensajes" class="show"><a href="/BandejaDeEntrada/" class="link">Mensajes</a></li>
{% endblock %}


{% block contenido %}

    <!-- Ventana Perfil Usuario -->

    <div class="section-header">
        <div class="container">
            <div class="row">
                <div class="col-sm-12">
                    <h1 class="animated slideInLeft"><span>{{ institucion.nombre }}</span></h1>
                </div>
            </div>
        </div>
    </div>

    <div class="container col-sm-offset-3">
    <div class="row">

        <!-- Menu del Perfil -->
        
        
        <!-- Foto del Perfil-->
        <div class="col-sm-8 col-md-6">
            <div class="row">

                <div class="col-sm-4">
                    <div class="thumbnail">
                        <div class="avatar">
                            <a href="#" class="thumbnail bottom-15" data-toggle="modal" data-target="#upload-avatar">
                                <img src="../../media/{{ institucion.logo }}" alt="...">
                            </a>

                        </div>
                    </div>
                </div>

            <!-- //// PERFIL PRINCIPAL ///// -->
            <div class="col-sm-8">
              <h3 class="hl">{{ institucion.nombre }} <br>
                <small> {{institucion.siglas}} </small></h3>
              <hr>
                <div class="col-sm-12" style="text-align:center" id="info_suscripcion"></div>
              <br>  

                <div>
                    <button class="col-sm-6 btn btn-green btn-sm" type="button" style="text-align:center;" onclick="window.location.href='/enviarMensaje/'"><i class="fa fa-envelope btn-sm"></i>Redactar Mensaje</button>
                    {% if not es_afiliado %}
                      <button class="col-sm-6 btn btn-blue btn-sm" id="btn_sucribirte" style="text-align:left;" type="button" data-toggle="popover"
                      data-placement="bottom">
                      <i class="fa fa-user-plus  btn-sm"></i>
                      Solicitar Membresia</button>   
                    {% endif %}                     
                   
                </div>
                
                
                <div id="popover_content_wrapper" data-placement="bottom" style="display: none" role="dialog">
                
                    <div>Complete el siguiente formulario:</div>
                    <br>
                    <label>Cargo</label>
                    <input id="txt_cargo" name="txt_cargo" type="text"
                                   class="form-control" id="cargo" placeholder="Ingrese su cargo">
                    <div style="display:none;" id="errorCargo" class="alert alert-danger" role="alert">El nombre del cargo es requerido y no debe contener caracteres especiales</div>
                    <br/>
                    <label>Descripci&oacute;n</label>
                    <textarea id="txt_description" style="resize:none" maxlength="400" rows="4" name="txt_description" type="text" class="form-control" id="descripcion" placeholder="Ingrese la descripcion del cargo"></textarea>
                    <div style="display:none;" id="errorDescripcion" class="alert alert-danger" role="alert">La descripci&oacute;n es requerida y no debe contener caracteres como ¿? ¡! $ % /\"</div>
                    <br/>
                    <button id="btn_aceptar_Suscripcion" type="button" class="btn btn-blue" style="left:30%">
                        Enviar
                    </button>
                    <button id="btn_cancelar_Suscripcion" type="button" class="btn btn-white" style="left:30%" data-toggle="clickover" onclick="$('#btn_sucribirte').popover('hide');">
                        Cancelar
                    </button>
                    
                </div>
                
            </div>

              <script>
              $(document).ready(function(){
                $(function(){

                  $('#info_suscripcion').removeClass("alert alert-info alert-warning");
                  $('#info_suscripcion').hide();
                  $('#btn_sucribirte').ready(function (){
                    console.log('dentro de la verificacion');
                    $.ajax({
                      data:{
                        'institucion':{{institucion.id_institucion}}
                      },
                      type:'get',
                      url: '/verificarSuscripcion/',
                      success: function(data){
                        var objeto = JSON.parse(data);
                        console.log(objeto);

                        if (objeto.existeMembresia) {
                          $('#btn_sucribirte').hide();
                          $('#info_suscripcion').show();

                          switch(objeto.estadoMembresia){
                              case -1:
                              //si existe membresia pero fue rechazado
                                $('#btn_sucribirte').show();
                                $('#info_suscripcion').hide();
                              break;
                              case 0:
                              //si existe membresia pendiente de accion
                                var html = "<p>Usted ya ha enviado una solicitud</p>"
                                $('#info_suscripcion').addClass("alert alert-warning");
                                $('#info_suscripcion').removeClass("alert-info");
                              break;
                              case 1:
                              //si existe membresia aceptada
                                var html = "<p>Usted ya pertenece a esta Institucion</p>"
                                $('#info_suscripcion').addClass("alert alert-info");
                                $('#info_suscripcion').removeClass("alert-warning");
                              break;
                          }

                        }else{
                          //no existe membresia
                          $('#btn_sucribirte').show();
                          $('#info_suscripcion').hide();
                        }
                        
                        $('#info_suscripcion').html(html);
                      }
                    });
                  });
                });
              });

              
                $(document).on('click','#btn_aceptar_Suscripcion',function(){
                    //alert($('#txt_cargo').val());
                    console.log('dentro de suscribirAInstitucion');
                    console.log($('#txt_cargo').text());
                    var formularioValido=validarSolicitud();
                    if(formularioValido == true){
                      $.ajax({
                          data: {
                          'cargo':$('#txt_cargo').val(),
                          'descripcion':$('#txt_description').val(),
                          'institucion' : {{institucion.id_institucion}},
                          'csrfmiddlewaretoken' : '{{ csrf_token }}'
                          },
                          type: 'post',
                          url: '/suscribirAInstitucion/',
                          success: function(data){
                                  var html = "<p>Se ha enviado la solicitud</p>";
                                  var objeto = JSON.parse(data);
                                  console.log(objeto);

                                  if (objeto.save_estado){
                                    $('#info_suscripcion').addClass("alert alert-success");
                                    $('#info_suscripcion').html(html);
                                    $('#info_suscripcion').removeClass("alert-info");
                                    $('#info_suscripcion').removeClass("alert-warning");
                                    $('#btn_sucribirte').popover('hide');
                                    $('#btn_sucribirte').hide();
                                    $('#info_suscripcion').show();
                                  }


                          }
                      });
                    }
                  });
                  function validarSolicitud()
                  {
                    var cargo = $('#txt_cargo').val();
                    var descripcion = $('#txt_description').val();
                    var patroncargo = /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/;
                    var patrondescripcion = /^[_/.,;/a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/;
                    var resultado1 = patroncargo.test(cargo);
                    var resultado2 = patrondescripcion.test(descripcion);
                    if(resultado1 == false)
                    {
                      $('#errorCargo').css("display","block");
                    }
                    else
                    {
                      $('#errorCargo').css("display","none");
                    }
                    if(resultado2 == false)
                    {
                      $('#errorDescripcion').css("display","block");
                    }
                    else
                    {
                      $('#errorDescripcion').css("display","none");
                    }
                    //alert('cargo: ' + resultado1 + ' descripcion '+ resultado2);
                    return resultado1 && resultado2;
                  }
            </script>
            </div>

            <br>
            <br>
            <br>
            <br>



            <!-- Informacion General-->
            

            <div class="row">
                <div class="col-sm-12">
                    <div class="col-sm-6" id="collapseGeneral">

                        <div class="panel-heading btn-outline btn-success"
                             style="text-align:center;background-color:#A2B2AC">
                            <h4 class="panel-title"><a data-toggle="collapse" data-parent="collapseGeneral"><i class="fa fa-info-circle"></i>
                                Informaci&oacute;n General </a></h4>
                        </div>
                        <div id="collapseInfoGeneral" class="panel-collapse collapse in">
                            <table class="table table-hover">
                                <tbody id="infoGeneralBody">

                                <tr>
                                    <td class="text-muted">Descripci&oacute;n</td>
                                    <td style="text-align:left">{{ institucion.descripcion }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Misi&oacute;n</td>
                                    <td style="text-align:left">{{ institucion.mision }}</td>
                                </tr>

                                <tr>
                                    <td class="text-muted">Pa&iacute;s</td>
                                    <td style="text-align:left">{{ institucion.pais }}</td>
                                </tr>

                                <tr>
                                    <td class="text-muted">P&aacute;gina Web</td>
                                    <td style="text-align:left;word-break: break-all;">{{ institucion.web }}</td>
                                </tr>

                                <tr>
                                    <td class="text-muted">Recursos Ofrecidos</td>
                                    <td style="text-align:left">{{ institucion.recursos_ofrecidos }}</td>
                                </tr>


                                </tbody>
                            </table>
                        </div>
                    </div>

                    
                    <div class="col-sm-6" id="collapseContacto">
                        <div class="panel-heading btn-outline btn-primary"
                             style="text-align:center;background-color:#123A82">
                            <h4 class="panel-title"><a data-toggle="collapse" data-parent="collapseContacto"><i class="fa fa-map-marker"></i>
                                Informaci&oacute;n de Contacto </a></h4>
                        </div>
                        <div id="collapseInfoContacto" class="panel-collapse collapse in">
                            <table class="table table-hover">
                                <tbody id="infoContactoBody">
                                <tr>
                                    <td class="text-muted">Nombre</td>
                                    <td style="text-align:left">{{ duenho.first_name }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Apellido</td>
                                    <td style="text-align:left">{{ duenho.last_name }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Tel&eacute;fono</td>
                                    <td style="text-align:left">{{ duenho.telefono }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Email</td>
                                    <td style="text-align:left">{{ duenho.email }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Website</td>
                                    <td style="text-align:left;word-break: break-all;">{{ duenho.web }}</td>
                                </tr>

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    /*
     Autor: Kevin Zambrano y Fausto Mora
     Nombre de funcion: funciones anonimas
     Entrada: eventos
     Salida: http
     Descripción: genera un handler para los eventos en la interaccion con suspender cuenta usuario
     */

    $(document).ready(function () {
        $('#btn_sucribirte').popover({
            html: true,
            content: function () { 
                return $('#popover_content_wrapper').html();
            }
        });
    });
</script>



{% endblock %}
